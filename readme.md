
Dans ce readme je vais vous apprendre √† setup un lab pour pouvoir analyser des virus avec Flare VM et REMnux.

## Topologie r√©seau üåê
<img src="/img/0.png" />
![[0.png]]

VM enti√®rement isoler du r√©seau qui ne pourrons pas avoir acc√®s √† internet et qui ne pourront que communiquer entre elle.

Notre premi√®re VM sera une VM Windows 10 avec **Flare VM** de installer dessus. 
La seconde VM sera une VM **REMnux** nous nous en servirons pour  simuler un sorte de "faux" internet avec l'outil **INetSim**.

## Pr√©requis üêõ

üîó ~ [Windows 10 ISO](https://www.microsoft.com/en-us/software-download/windows10) 
üîó ~ [REMnux ISO](https://remnux.org/?ltclid=#distro)
üîó ~ [FlareVM](https://github.com/mandiant/flare-vm)  
üîó ~ [Oracle VM VirtualBox](https://www.virtualbox.org/wiki/Downloads)

## Installation ü¶ã

Pour commencer nous allons devoir configurer nos machines sur Virtual Box.

### Windows VM ü™ü

Importer le fichier **Windows.iso** dans Virtual Box en cliquant sur **le bouton Nouvelle**.
Ensuite configurer le nom et s√©lectionner votre .iso
<img src="/img/1.png" />
![[1.png]]

Pour le nom d'utilisateur √ßa sera **vm** et le mot de passe **erty** et le hostname **FlareVM**
<img src="/img/2.png" />
![[2.png]]

Pour la **ram** je vous conseille un **minimum de 8GO** et pour le **processeur** vous pouvez allouer **quatre c≈ìur physique** si votre processeur vous le permet.
<img src="/img/3.png" />
![[3.png]]Pour la taille du disque pour votre VM je vous conseille au minimum 80GO 
<img src="/img/4.png" />
![[4.png]]Cliquer ensuite sur **Finish** pour ajouter la VM

S√©lectionner la VM Windows 10 cliquer sur le bouton **Configuration** puis cliquer sur l'onglet **Affichage** et pour le contr√¥leur graphique prendre **VBoxSVGA** et en dans Fonctions avanc√©es **cochez activer l'acc√©l√©rations 3D** dans m√©moire vid√©o mettez le maximum possible. 
<img src="/img/5.png" />
![[5.png]]

Si Windows est votre syst√®me principal **d√©sactivez Hyper-V** pour √©viter tous conflit vous devez faire la touche **win + q** et dans l'onglet recherche √©crire **Activer ou d√©sactiver des fonctionnalit√©s Windows** puis d√©cocher **Plateforme de l'hyperviseur Windows**
<img src="/img/6.png" />
![[6.png]]


### REMnux VMüêß

Ici pour REMnux c'est encore plus simple car comme c'est un .ova la VM est d√©j√† configurer.
Cliquez sur la cat√©gorie **Outils** puis cliquer sur le bouton **Importer** puis ajouter votre **fichier .ova**
<img src="/img/7.png" />
![[7.png]]

Ensuite cliquez simplement sur **Suivant** et **Finish**


## Installer FlareVM et Configurer INetSim ‚å®Ô∏è

### Windows FlareVM Installation ü™ü

Vous devez pour le processus d'installation de FlareVM **vous connecter √† internet.**

S√©lectionnez la VM Windows 10 puis cliquez sur le bouton **Configuration** puis cliquer sur l'onglet r√©seau et choisir pour mode d'acc√®s r√©seau **l'acc√®s par pont**
<img src="/img/8.png" />
![[8.png]]

Ensuite lancer votre VM avec le bouton d√©marrer en vert.

**T√©l√©charger de fichier .zip sur le repo github de Flare VM** ensuite il faut **unzip le zip** et d√©poser le fichier sur le bureau de votre VM Windows 10
<img src="/img/9.png" />
![[9.png]]
<img src="/img/10.png" />
![[10.png]]

Vous devez d√©sactiver Windows Defender sur votre VM Windows 10 car il pourrais nuire √† nos analyse de malware. Pour se faire rdv dans l'onglet recherche avec la touche **win + q** et chercher **s√©curit√© Windows**. Puis cliquer sur **Protection contre les virus et menaces** et d√©cocher tous. Pareil dans **Pare-Feu et protection du r√©seau**.
<img src="/img/11.png" />
![[11.png]]
<img src="/img/12.png" />
![[12.png]]

Maintenant que cella est fait lancer un Windows **PowerShell en mode administrateur**
<img src="/img/13.png" />
![[13.png]]

maintenant vous devez vous rendre dans votre dossier flare-vm-main qui se trouve sur votre bureau. avec la commande `cd C:\Users\User\Desktop\flare-vm-main`
<img src="/img/14.png" />
![[14.png]]

puis rentrer les commandes suivante √† la suite 

`(New-Object net.webclient).DownloadFile('https://raw.githubusercontent.com/mandiant/flare-vm/main/install.ps1',"install.ps1")`

`Unblock-File .\install.ps1`

`Set-ExecutionPolicy Unrestricted -Force`
<img src="/img/15.png" />
![[15.png]]

cliquer tous le temps sur **Y pour Yes**

Nous allons devoir choisir les paquets que nous voulons installer pour ma part je vais laisser par d√©faut je vais juste retirer **ghidra** et **notepad++** car je n'aime pas vraiment utiliser c'est deux logiciel. cliquer sur **tab** pour vous diriger sur le bouton entrer une fois dessus cliquer sur la touche **entrer** pour valider. 
<img src="/img/16.png" />
![[16.png]]

Une fois l'installation terminer votre VM vas **red√©marrer** et hop FlareVM est installer 
<img src="/img/17.png" />
![[17.png]]


### REMnux VM INetSim Configurationüêß

lancer un terminal et faite `setxkbmap fr` pour mettre votre clavier en Fran√ßais

on vas devoir √©diter le fichier de configuration de INetSim avec

`sudo nano /etc/inetsim/inetsim.conf`

d√©commenter la ligne **start service_dns**
<img src="/img/18.png" />
![[18.png]]

d√©commenter la ligne service_bind_address et rentrer l'ipv4 **0.0.0.0** conform√©ment √† la documentation de REMnux
<img src="/img/19.png" />
![[19.png]]

d√©commenter aussi ligne dns_default_ip et rentrer l'ipv4 de votre choix pour ma part je vais rentrer conform√©ment √† ma topologie **10.0.0.2** 

<img src="/img/20.png" />
![[20.png]]


puis **ctrl + x** et **y** et la touche **entrer** pour sauvegarder le fichier  

entrer la commande pour d√©sactiver le r√©solveur dns par d√©faut et utiliser celui de INetSim conform√©ment √† la documentation de REMnux 

`sudo systemctl disable systemd-resolved.service`

`sudo service systemd-resolved stop`
## Virtual Box configuration r√©seau üîå

Dans cette section nous allons configurer nos deux VM pour faire en sorte qu'elle ne communique que entre elle et qu'elle n'on pas acc√®s √† internet. De ce fait aucun virus ne pourra venir infecter notre r√©seau.  Nous nous en tiendrons strictement √† la topologie r√©seau vue pr√©c√©demment.  

### Windows VM ü™ü 

Dans Virtual Box s√©lectionner votre VM Windows 10 puis cliquez sur le **bouton Configuration**
et **s√©lectionnez la cat√©gorie R√©seau** et dans mode d'acc√®s r√©seau choisir **r√©seau interne**
en name vous pouvez √©crire ce que vous voulez pour ma part √ßa sera **malware**. 
<img src="/img/21.png" />
![[21.png]]

Dans **G√©n√©ral** puis l'onglet **Avancer** bien v√©rifier que le presse-papier partag√© et le glisser-d√©poser son bien en **Disable**
<img src="/img/22.png" />
![[22.png]]

Enfin cliquer sur **ok** pour sauvegarder.

### REMnux VMüêß

M√™me chose **Configuration** puis **R√©seau** s√©lectionner dans mode d'acc√®s r√©seau prendre **r√©seau interne** et dans name s√©lectionner avec le menu d√©roulant le nom pr√©c√©demment cr√©er soit dans mon cas **malware**
<img src="/img/23.png" />
![[23.png]] 

Aussi bien penser √† v√©rifier dans **g√©n√©ral** et l'onglet **avancer** que le presse papier partag√© et le glisser d√©poser son bien en **Disable**

## OS configuration r√©seau üíª

### Windows VM ü™ü 

Sur notre machine Windows nous allons passer directement par l'interface graphique pour assigner l'adresse IP et le masque correspondant √† notre sch√©ma soit 

@IP : 10.0.0.1
@MAC : 255.255.255.0

Vous devez vous rendre dans les **Param√®tres > R√©seau et internet > Ethernet > modifier les options d'adaptateur > puis clique droit et propri√©t√©**
<img src="/img/24.png" />
 ![[24.png]]

et s√©lectionner **Protocol internet version 4 (TCP /IPv4)**
<img src="/img/25.png" />
![[25.png]]

maintenant il vous suffit de rentrer la m√™me chose que moi et ensuite de cliquer sur ok
<img src="/img/26.png" />
![[26.png]]

### REMnux VMüêß

**ifconfig** pour voir le nom de mon interface r√©seau ici c'est **enp0s3**
<img src="/img/27.png" />
![[27.png]]

Sur notre machine REMnux nous allons passer par la ligne de commande (CLI) pour assigner l'adresse IP et le masque correspondant √† notre sch√©ma soit 

@IP : 10.0.0.2
@MAC : 255.255.255.0

J'utilise la commande `sudo ip addr add 10.0.0.2/24 dev enp0s3` pour ajouter l'ip et le masque √† mon interface r√©seau correspondante
<img src="/img/28.png" />
![[28.png]]


## V√©rification configuration r√©seau üëç

On vas effectuer une s√©ries de ping de 

Windows --------> REMnux
REMnux ---------> Windows

parfait nos deux machines peuvent se ping de fa√ßon successive 
<img src="/img/29.png" />
![[29.png | 900]]

on vas maintenant v√©rifier si **INetSim** (pour Internet Services Simulation Suite) fonctionne correctement pour rappelle  **INetSim** vas nous permettre "d'√©muler une fausse connexion √† internet sans √™tre r√©ellement connecter au r√©seau internet" ce qui vas nous permettre de pouvoir intercepter les requ√™tes DNS ou bien FTP etc...

On lance INetSim sur notre machine REMnux avec la commande 

`inetsim`
<img src="/img/30.png" />
![[30.png]]

si on se rend sur notre machine FlareVM et qu'on rentre 10.0.0.2 ou bien n'importe qu'elle nom de domaine on vois cela 
<img src="/img/31.png" />
![[31.png | 1000]]
<img src="/img/32.png" />
![[32.png | 1000]]

c'est donc bien configurer 

Aussi si vous voulez intercepter uniquement les requ√™tes DNS vous pouvez utiliser **fakedns** sur votre machine REMnux pour intercepter seulement les requ√™tes DNS de votre machine FlareVM.
<img src="/img/33.png" />
![[33.png]]

sinon avec INetSim si vous voulez pouvoir visualiser toutes les requ√™tes que vous avez intercepter vous devez utiliser le logiciel **wireshark** sur votre machine REMnux.

## Snapshot üì∑

Je vous conseille d'effectuer une snapshot (instantan√© en fran√ßais) de votre machine Windows FlareVM au cas ou vous la casser √† cause d'un virus ou d'une mauvaise manipulation cela pourra vous permettre de revenir √† un √©tat propre.

cliquer sur **machine > prendre un instantan√©
<img src="/img/34.png" />
![[34.png]]


Le tutoriel est maintenant terminer.

## Bonus üëÄ

### T√©l√©charger des samples de malware

Si vous voulez des samples de malware vous pouvez vous rendre sur 

- https://vx-underground.org/Samples
- https://bazaar.abuse.ch/browse/

